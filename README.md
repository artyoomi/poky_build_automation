## Poky build automation

This project is selection assignment for the "Yadro" laboratory at ETU "LETI" University

### Task 
Необходимо реализовать скрипты и инструкции для построения образа ОС (rootfs) в соответствии со следующими пунктами:
1. Познакомиться с Yocto Project: https://www.yoctoproject.org/. Разобраться, как настроить окружение для сборки Yocto (дистрибутив Poky). Собрать простейший образ (цель core-image-minimal). Убедиться, что он запускается в QEMU. Используйте версию Yocto: Kirkstone.
2. Реализовать автоматизацию сборки через Docker. В контейнере необходимо реализовать сборку образа и запуск образа в QEMU. Выбор между сборкой и запуском необходимо реализовать через аргументы, передаваемые контейнеру при запуске. Лучше всего использовать docker volume, чтобы собирать все исходные файлы в директории на хост-машине (то есть, загрузка и сборка образа осуществляется в docker volume). В качестве базового Docker образа используйте: ubuntu:20.04. 
3. Добавить в образ программу yadro_hello. Программа должна выводить в поток стандартного вывода строку “Hello from my own program!”. Программа должна быть написана на языке C. Добавление программы необходимо осуществить посредством создания слоя Yocto.
 
Требования к выполнению задания:
- Сборка образа ОС и запуск виртуальной машины QEMU должны запускаться внутри Docker-контейнера
- Нобходимо создать свой репозиторий для данного задания. Репозиторий должен содержать файлы исходного кода, dockerfile, скрипты для сборки и запуска задания и инструкцию для запуска и сборки
- Для каждого пункта заданий должна быть инструкция по тому, как оно реализовано, и команда для воспроизведения

### Results
1) Успешно разобрался с тем как собрать минимальной образ на своей хост машине, образ был успешно запущен в QEMU.
2) На данный момент происходит сборка, но после сборки образ почему-то не запускается в QEMU. Кроме того сохранение полученной
   сборки возможно только если выставить для директории с исходными данными права 777.
4) Реализовал добавление слоя через скрипты bitbake.

Всё та же проблема с правами доступа, пока нашёл обходной путь через chmod 777 poky, но данное решение далеко от хорошего,
пробовал монтировать в контейнер файлы, содержащие группы и пользователей с хост-машины. Однако при попытке такого монтирова-
ния появляется ошибка о том, что заданный пользователь не может быть найден.
Команда: docker run -e mode=build --name poky_cont --rm -v /etc/passwd:/etc/passwd:ro -v /etc/group:/etc/group:ro --user $(whoami) 
-v $(pwd)/poky:/poky poky_image
Ошибка: docker: Error response from daemon: unable to find user artyom: no matching entries in passwd file.

Файлы, необходимые для решения задачи ========================
- get_poky.sh:
  Скрипт для клонирования репозитория дистрибутива Poky и создания локальной ветки версии kirkstone
- add_layer.sh:
  Скрипт для создания слоя Poky, инициализирует среду сборки, создаёт слой и помещает исходный код программы yadro_hello.c
  в папку с рецептом сборки. Вместе с ним идёт файл compile_instr.txt, который содержит инструкции для bitbake, с помощью которых
  программа yadro_hello.c компилируется
- mode_selection.sh:
  Файл, необходимый для выбора режима запуска контейнера.
- Dockerfile:
  - FROM ubuntu:20.04 - сборка на базовом образе ubuntu версии 20.04
  - RUN apt update && DEBIAN_FRONTEND=noninteractive ... - обновление репозитория и установка необходимых зависимостей,
    переменная окружения DEBIAN_FRONTEND=noninteractive используется для отключения интерактивного выбора при установе
  - RUN groupadd -gid ... - добавления новой группы с id 1024 и пользователя в этой группе, создание папки пользователя node
  - USER 1024 - переключение на пользователя с id 1024. Новый пользователь нужен так как bitbake не выполняет сборку от
  - пользователя root.
  - WORKDIR /home/node - использование созданной директории пользователя для сборки проекта
  - COPY mode_selection.sh ... - для копирования необходимых для сборки скриптов в контейнер
  - CMD bash mode_selection.sh.sh - для начала сборки проекта

Инструкция по воспроизведению ========================
1) Склонировать данный репозиторий
2) Выполнить скрипт get_poky.sh с помощью source в папке репозитория, скрипт склонирует репозиторией и создаст локальную ветку с poky версии
kirkstone и изменить права доступа к папке на 777, т.е. чтение, запись и исполнение для всех.
3) Создать образ для Docker: docker build -t poky_image .
4) Запустить сборку проекта Poky: "docker run -e mode=build --name poky_cont --rm -v \$(pwd)/poky:/home/node/poky poky_image", режим сборки выбирать
   изменением параметра mode на build - режим сборки, run - режим запуска образа в QEMU.
